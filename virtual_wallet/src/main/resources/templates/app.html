<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Blinker</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <!-- Bootstrap Icons (para iconos bonitos en los botones) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            min-height: 100vh;
            display: flex;
        }
        .custom-sidebar {
            background-color: #2b2f38;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            color: #fff;
            width: 250px;
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        .custom-sidebar .nav-pills > .nav-item > .nav-link.active,
        .custom-sidebar .nav-pills > .nav-item > .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.15); /* azul Bootstrap primary al 15% de opacidad */
        }

        .custom-sidebar #logout-link,
        .custom-sidebar #logout-link:hover {
            background-color: transparent;
        }

        .custom-sidebar .nav-link {
            color: white;
        }
        .custom-sidebar .nav-link i {
            color: #0d6efd;
        }
        .custom-sidebar #logout-link,
        .custom-sidebar #logout-link i {
            color: #dc3545;
        }
        .custom-sidebar #logout-link:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .custom-sidebar .nav-link:hover {
            background-color: #495057;
        }
        .content {
            flex-grow: 1;
            padding: 20px;
            background-color: #1c1f26;
            color: white;
        }
        .custom-card {
            background-color: #2b2f38;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 2rem;
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .transaction-item {
            background-color: #343a40;
            border-radius: 0.5rem;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
        }
        .settings-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .custom-card {
            margin-bottom: 20px;
        }

        .form-select, .btn {
            width: 100%;
        }

    </style>
</head>
<body>



<!-- Sidebar -->
<div class="sidebar custom-sidebar">
    <h4 class="text-center">Blinker</h4>
    <hr>
    <ul class="nav nav-pills flex-column flex-grow-1">
        <li class="nav-item"><a href="#" class="nav-link" data-section="home"><i class="bi bi-house-door-fill me-2"></i>Home</a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-section="profile"><i class="bi bi-person-fill me-2"></i>Profile</a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-section="wallets"><i class="bi bi-diagram-3-fill me-2"></i>Wallets</a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-section="history"><i class="bi bi-clock-history me-2"></i>History</a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-section="statistics"><i class="bi bi-bar-chart-fill me-2"></i>Statistics</a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-section="settings"><i class="bi bi-gear-fill me-2"></i>Settings</a></li>
    </ul>
    <hr>
    <ul class="nav nav-pills flex-column mt-auto">
        <li class="nav-item">
            <a href="#" class="nav-link" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Log out</a>
        </li>
    </ul>
</div>

<!-- Content -->


<!--
/////////////
////////////
////////////
///////////
Content js-->
<script th:inline="javascript">
    /*<![CDATA[*/
    const userName = /*[[${user.name}]]*/ "Desconocido";
    const userEmail = /*[[${user.email}]]*/ "Sin email";
    const user = /*[[${user}]]*/ null;
    console.log("User:", user);
    /*]]>*/
</script>

<script>
    let cuentas = [];

    // Actualiza todos los lugares donde mostramos balance en caliente
    function refreshBalances() {
        // 1) Home
        fetch("/users/getAccounts", { method: "POST" })
            .then(r => r.ok ? r.json() : Promise.reject("Error"))
            .then(accts => {
                const total = accts.reduce((s,a) => s + parseFloat(a.balance), 0).toFixed(2);
                document.querySelectorAll(".balance-amount").forEach(el => {
                    el.textContent = `$${total}`;
                });
            })
            .catch(console.error);

        // 2) Profile (si existe el badge de profile)
        fetch("/users/getAccounts", { method: "POST" })
            .then(r => r.ok ? r.json() : Promise.reject("Error"))
            .then(accts => {
                const total = accts.reduce((s,a) => s + parseFloat(a.balance), 0).toFixed(2);
                const prof = document.getElementById("profile-balance");
                if (prof) prof.textContent = `$${total}`;
            })
            .catch(console.error);
    }


    async function getAccounts() {
        try {
            const response = await fetch("/users/getAccounts", {
                method: "POST"
            });
            if (!response.ok) {
                throw new Error("Error al obtener las cuentas");
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error("Error:", error);
            return [];
        }
    }

    async function init() {
        cuentas = await getAccounts();
    }
    init();
    document.addEventListener("DOMContentLoaded", () => {

        const content = document.getElementById("main-content");
        const logoutLink = document.getElementById("logout-link");


        const views = {
            home: `
    <div class="settings-container">
      <h1 class="mb-4">Balance Dashboard</h1>

      <!-- Balance Card -->
      <div class="card custom-card mb-4">
        <h3>Current Balance</h3>
        <p class="balance-amount">$0.00</p>
        <div class="d-flex justify-content-center flex-wrap gap-3 mt-4">
          <button class="btn btn-primary px-4" id="send-link">
            <i class="bi bi-send-fill me-2"></i>Send
          </button>
          <button class="btn btn-success px-4" id="deposit-link">
            <i class="bi bi-wallet2 me-2"></i>Deposit
          </button>
          <button class="btn btn-info px-4" id="btn-bank-accounts">
            <i class="bi bi-credit-card-2-front-fill me-2"></i>Bank Accounts
          </button>
        </div>
      </div>

      <!-- User Rank Card -->
      <div class="card custom-card mb-4">
        <div class="d-flex align-items-center mb-3">
          <i class="bi bi-award-fill me-2" style="font-size: 1.5rem; color: gold;"></i>
          <h4 class="mb-0">Your Rank</h4>
        </div>
        <div class="d-flex align-items-center mb-2">
          <span id="user-rank-badge" class="badge bg-secondary me-3">Bronze</span>
          <div class="flex-grow-1">
            <div class="progress" style="height: .6rem;">
              <div id="user-rank-progress"
                   class="progress-bar bg-warning"
                   role="progressbar"
                   style="width: 0%;"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <small id="user-rank-text" style="color: white;">0 / 500 pts</small>
          </div>
        </div>
      </div>

      <!-- Movements -->
      <div class="card custom-card">
        <h3 class="mb-3">Movements</h3>
        <div id="recent-transactions"></div>
        <a href="#" id="see-history" class="btn btn-link text-white mt-3 p-0">
          See all movements
        </a>
      </div>
    </div>
  `,
            profile: `
    <div class="settings-container">
      <h2 class="mb-4">Profile</h2>

      <!-- User Information -->
      <div class="card custom-card mb-4">
        <h4 class="mb-3">User Information</h4>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Name:</div>
          <div class="col-md-8">${userName}</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Email:</div>
          <div class="col-md-8">${userEmail}</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Total Balance:</div>
          <div id="profile-balance" class="col-md-8 text-success fw-bold">$0.00</div>
        </div>
      </div>

      <!-- User Rank in Profile -->
      <div class="card custom-card mb-4">
        <div class="d-flex align-items-center mb-3">
          <i class="bi bi-award-fill me-2" style="font-size: 1.5rem; color: gold;"></i>
          <h4 class="mb-0">Your Rank</h4>
        </div>
        <div class="d-flex align-items-center mb-2">
          <span id="profile-rank-badge" class="badge bg-secondary me-3">Bronze</span>
          <div class="flex-grow-1">
            <div class="progress" style="height: .6rem;">
              <div id="profile-rank-progress"
                   class="progress-bar bg-warning"
                   role="progressbar"
                   style="width: 0%;"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <small id="profile-rank-text" style="color: white;">0 / 500 pts</small>
          </div>
        </div>
      </div>

      <!-- Account Actions -->
      <div class="card custom-card">
        <h4 class="mb-3">Account Actions</h4>
        <div class="d-flex gap-3">
          <button class="btn btn-outline-light">
            <i class="bi bi-pencil-fill me-2"></i>Edit Profile
          </button>
          <button class="btn btn-outline-danger">
            <i class="bi bi-trash-fill me-2"></i>Delete Account
          </button>
        </div>
      </div>
    </div>
  `,wallets: `
  <div class="settings-container">
    <h2 class="mb-4">My Wallets</h2>

    <div class="card custom-card mb-4">
      <h4 class="mb-3">Create New Wallet</h4>
      <form id="wallet-create-form">
        <div class="mb-3">
          <label for="wallet-name" class="form-label">Wallet Name</label>
          <input type="text" id="wallet-name" class="form-control bg-dark text-white border-secondary"
                 placeholder="e.g. Savings" required>
        </div>
        <button type="submit" class="btn btn-success">Create Wallet</button>
      </form>
    </div>

    <div class="card custom-card">
      <h4 class="mb-3">Your Wallets</h4>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="wallet-table-body"></tbody>
        </table>
      </div>

      <h5 class="mt-4">All Wallets List (for graph connect)</h5>
      <ul id="wallet-list" class="list-group list-group-flush bg-dark mb-3"></ul>


      <h5 class="mt-4">Transfer Between Wallets</h5>
<form id="wallet-transfer-form" class="d-flex gap-2 mb-3">
  <select id="wallet-from" class="form-select bg-dark text-white">
    <option value="">From</option>
  </select>
  <select id="wallet-to" class="form-select bg-dark text-white">
    <option value="">To</option>
  </select>
  <input type="number" id="wallet-transfer-amount" class="form-control bg-dark text-white" placeholder="Amount">
  <button type="submit" class="btn btn-warning">Transfer</button>
</form>
      <h5>Connect Wallets</h5>
      <form id="wallet-connect-form" class="d-flex gap-2 mb-3">
        <select id="source-wallet" class="form-select bg-dark text-white">
          <option value="">From</option>
        </select>
        <select id="target-wallet" class="form-select bg-dark text-white">
          <option value="">To</option>
        </select>
        <button type="submit" class="btn btn-primary">Connect</button>
      </form>

      <h5>Graph Structure</h5>
      <pre id="wallet-graph" class="bg-dark p-3" style="white-space: pre-wrap;"></pre>
    </div>
  </div>
`

            ,
            history: `
  <h2 class="mb-4">Movements</h2>
  <div class="card custom-card">
    <h4 class="mb-3">All movements</h4>
    <div class="table-responsive">
      <table class="table table-dark table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Destiny</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="all-transactions"></tbody>
      </table>
    </div>
  </div>
`,statistics: `
  <div class="container mt-4">
    <h2 class="mb-4">Statistics</h2>

    <!-- 1) Patrones por categoría -->
    <div class="card custom-card mb-4">
      <div class="card-body">
        <h5 class="card-title">Spending Patterns by Category</h5>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <!-- 2) Transferencias frecuentes -->
    <div class="card custom-card mb-4">
      <div class="card-body">
        <h5 class="card-title">Frequent Transfer Targets</h5>
        <canvas id="clientGraphChart"></canvas>
      </div>
    </div>

    <!-- 3) Grupos de afinidad -->
    <div class="card custom-card mb-4">
      <div class="card-body">
        <h5 class="card-title">Affinity Groups</h5>
        <div id="affinity-groups" class="d-flex flex-column gap-2 text-light"></div>
      </div>
    </div>
  </div>
`
            ,

            settings: `
                <div class="settings-container">
                    <h2>Settings</h2>
                    <div class="card custom-card mb-4">
                        <h4>Language</h4>
                        <select class="form-select bg-dark text-white border-secondary">
                            <option selected>English</option>
                            <option>Spanish</option>
                            <option>French</option>
                        </select>
                    </div>
                    <div class="card custom-card">
                        <h4>Account Management</h4>
                        <button class="btn btn-outline-primary mb-3">Manage Accounts</button>
                        <button class="btn btn-outline-danger">Delete Account</button>
                    </div>
                </div>

            `,
            bank_accounts:`
                <div class="settings-container">
                    <h2 class="mb-4">Bank Accounts</h2>

                    <div class="card custom-card mb-4">
                        <h4 class="mb-3">Available Accounts</h4>
                        <ul id="bank-accounts-list" class="list-group list-group-flush bg-dark">

                        </ul>
                    </div>

                    <form id="account-form" action="/Accounts/add" method="POST">
                        <div class="card custom-card">
                            <h4 class="mb-3">Add account</h4>
                            <div class="mb-3">
                                <label for="account-number" class="form-label">Number Account</label>
                                <input
                                    type="number"
                                    class="form-control bg-dark text-white border-secondary"
                                    id="account-number"
                                    name="accountNumber" required
                                />

                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus-circle me-2"></i>Add
                            </button>
                        </div>
                    </form>
                </div>

            `
        };

        if (logoutLink) {
            logoutLink.addEventListener("click", function (e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById("logout-modal"));
                modal.show();
            });
        }

        // Confirmación de logout
        const confirmLogoutBtn = document.getElementById("confirm-logout");
        if (confirmLogoutBtn) {
            confirmLogoutBtn.addEventListener("click", function () {
                alert("Logged out!"); // Reemplaza esto por tu lógica real
                window.location.href = "/home/gotosignin";
            });
        }

        function loadView(view) {
            content.innerHTML = views[view] || "<h2>Not Found</h2>";

            // 1) Modales de depósito y envío
            document.getElementById("deposit-link")
                ?.addEventListener("click", async e => {
                    // Mostrar el modal
                    const modalElement = document.getElementById("deposit-modal");
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();

                    // Limpiar opciones anteriores
                    const select = document.getElementById("selectPurse2");
                    select.innerHTML = '<option value="">-- Select an account --</option>';


                    try {
                        const response = await fetch("/users/getAccounts", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }
                        });

                        if (!response.ok) throw new Error("Error fetching accounts");

                        const accounts = await response.json();

                        accounts.forEach(account => {
                            const option = document.createElement("option");
                            option.value = account.accountNumber;
                            option.textContent = `Account Number: ${account.accountNumber} - $${account.balance}`;
                            select.appendChild(option);
                        });
                    } catch (error) {
                        console.error("Error loading accounts:", error);
                        const errorOption = document.createElement("option");
                        errorOption.disabled = true;
                        errorOption.textContent = "Error loading accounts";
                        select.appendChild(errorOption);
                    }
                    //////////
                    /////////

                });

            document.getElementById("deposit-form")?.addEventListener("submit", e => {
                e.preventDefault();
                const accountDestiny = +document.getElementById("selectPurse2").value;
                const amount        = parseFloat(document.getElementById("depositAmount").value);
                if (!accountDestiny || !amount) return alert("Completa todos los campos");

                fetch(`/transaction/deposit?depositAmount=${amount}&accountOriginNumber=<TU_ORIGIN_ID>&accountDestiny=${accountDestiny}`, {
                    method: "POST"
                })
                    .then(r => r.ok ? r.json() : r.text().then(t=>Promise.reject(t)))
                    .then(_ => {
                        refreshBalances();                    // 🟢 recalcula balance
                        bootstrap.Modal.getInstance(
                            document.getElementById("deposit-modal")
                        ).hide();
                        loadView("home");                    // o donde quieras volver
                    })
                    .catch(err => alert(err));
            });

            document.getElementById("send-link")?.addEventListener("click", async (e) => {
                e.preventDefault();


                // Mostrar el modal
                const modalElement = document.getElementById("send-money-modal");
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Limpiar opciones anteriores
                const select = document.getElementById("selectPurse");
                select.innerHTML = '<option value="">-- Select an account --</option>';

                const selectC = document.getElementById("selectCategory");
                selectC.innerHTML = '<option value="">-- Select a Category --</option>';


                try {
                    const response = await fetch("/users/getAccounts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });

                    if (!response.ok) throw new Error("Error fetching accounts");

                    const accounts = await response.json();

                    accounts.forEach(account => {
                        const option = document.createElement("option");
                        option.value = account.id;
                        option.textContent = `Account Number: ${account.accountNumber} - $${account.balance}`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error loading accounts:", error);
                    const errorOption = document.createElement("option");
                    errorOption.disabled = true;
                    errorOption.textContent = "Error loading accounts";
                    select.appendChild(errorOption);
                }
                //////////
                /////////

                try {
                    const response = await fetch("/users/getCategories", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });

                    if (!response.ok) throw new Error("Error fetching categories");

                    const categories = await response.json();
                    const select = document.getElementById("selectCategory");
                    select.innerHTML = "";

                    const defaultOption = document.createElement("option");
                    defaultOption.value = "";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    defaultOption.textContent = "Select a category";
                    select.appendChild(defaultOption);

                    categories.forEach(category => {
                        const option = document.createElement("option");
                        option.value = category;
                        option.textContent = category.charAt(0).toUpperCase() + category.slice(1).toLowerCase();
                        select.appendChild(option);
                    });

                } catch (error) {
                    console.error("Error loading categories:", error);
                    const errorOption = document.createElement("option");
                    errorOption.disabled = true;
                    errorOption.textContent = "Error loading categories";
                    select.appendChild(errorOption);
                }

            });

            document.getElementById("send-form")?.addEventListener("submit", e => {
                e.preventDefault();
                const accountNumber   = +document.getElementById("inputDestinyAccount").value;
                const accountOriginId = +document.getElementById("selectPurse").value;
                const amount          = parseFloat(document.getElementById("inputAmount").value);
                const description     = document.getElementById("inputDescription").value;
                const category        = document.getElementById("selectCategory").value;

                if (!accountNumber || !accountOriginId || !amount || !category) {
                    return alert("Completa todos los campos");
                }

                fetch(`/transaction/send?accountNumber=${accountNumber}`
                    + `&amount=${amount}`
                    + `&description=${encodeURIComponent(description)}`
                    + `&accountOriginId=${accountOriginId}`
                    + `&category=${category}`, {
                    method: "POST"
                })
                    .then(r => r.ok ? r.json() : r.text().then(t=>Promise.reject(t)))
                    .then(_ => {
                        refreshBalances();                    // 🟢 recalcula balance
                        bootstrap.Modal.getInstance(
                            document.getElementById("send-money-modal")
                        ).hide();
                        loadView("home");                    // o donde quieras volver
                    })
                    .catch(err => alert(err));
            });

            document.getElementById("btn-bank-accounts")?.addEventListener("click", e => {
                e.preventDefault();
                loadView("bank_accounts");
            });

            if (view === "home") {
                fetch("/users/getAccounts", { method: "POST" })
                    .then(res => {
                        if (!res.ok) throw new Error("Error fetching accounts");
                        return res.json();
                    })
                    .then(accts => {
                        // sumo los balances de todas las cuentas
                        const total = accts.reduce((sum, a) => sum + parseFloat(a.balance), 0);
                        // muestro en el panel
                        refreshBalances();
                        document.querySelector(".balance-amount").textContent = `$${total.toFixed(2)}`;
                    })
                    .catch(err => console.error("Error loading balance:", err));
                // 1) navegación a Movements
                document.getElementById("see-history")?.addEventListener("click", e => {
                    e.preventDefault();
                    loadView("history");
                });

                // 2) fetch de rango y puntos
                fetch("/points/top?n=1")
                    .then(res => {
                        if (!res.ok) throw new Error("Network response was not ok");
                        return res.json();
                    })
                    .then(data => {
                        if (!data.length) return;
                        const { accumulatedPoints, rangeUser } = data[0];
                        const limits = { BRONZE: 500, SILVER: 1000, GOLD: 5000, PLATINUM: Number.MAX_SAFE_INTEGER };
                        const maxPts = limits[rangeUser] || 500;
                        const pct    = Math.min(100, Math.round(accumulatedPoints / maxPts * 100));

                        document.getElementById("user-rank-badge").textContent =
                            rangeUser.charAt(0) + rangeUser.slice(1).toLowerCase();
                        const bar = document.getElementById("user-rank-progress");
                        bar.style.width = pct + "%";
                        bar.setAttribute("aria-valuenow", pct);
                        document.getElementById("user-rank-text").textContent =
                            `${accumulatedPoints} / ${maxPts} pts`;
                    })
                    .catch(err => console.error("Error loading points:", err));

                // 3) fetch de 3 transacciones recientes con tipado y colores
                fetch("/transaction/recent")
                    .then(r => {
                        if (!r.ok) throw new Error("Error fetching recent transactions");
                        return r.json();
                    })
                    .then(data => {
                        const container = document.getElementById("recent-transactions");
                        if (!data.length) {
                            container.innerHTML = "<p class='text-center'>No transactions yet.</p>";
                            return;
                        }
                        container.innerHTML = data.map(tx => {
                            // Traducir tipo y elegir icono + color
                            let iconClass, amountClass, tipoLabel;
                            switch (tx.type) {
                                case "DEPOSIT":
                                    tipoLabel   = "Depósito";
                                    iconClass   = "bi-arrow-down-circle text-success";
                                    amountClass = "text-success";
                                    break;
                                case "WITHDRAWAL":
                                    tipoLabel   = "Retiro";
                                    iconClass   = "bi-arrow-up-circle text-danger";
                                    amountClass = "text-danger";
                                    break;
                                case "TRANSFER":
                                    tipoLabel   = "Transferencia";
                                    iconClass   = "bi-arrow-right-circle text-warning";
                                    amountClass = "text-warning";
                                    break;
                                default:
                                    tipoLabel   = tx.type;
                                    iconClass   = "bi-circle";
                                    amountClass = "";
                            }

                            let sign = "+";
                            if (tx.type === "WITHDRAWAL" || tx.type === "TRANSFER") {
                                sign = "-";
                            } else if (tx.type === "RECEIVED" || tx.type === "DEPOSIT") {
                                sign = "+";
                            }

                            const absAmt = Math.abs(tx.amount).toFixed(2);

                            return `
        <div class="transaction-item d-flex justify-content-between align-items-center">
          <span>
            <i class="bi ${iconClass} me-2"></i>
            ${tipoLabel}: ${tx.description || ""}
          </span>
          <span class="${amountClass}">
            ${sign} $${absAmt}
          </span>
        </div>
      `;
                        }).join("");
                    })
                    .catch(err => console.error("Error loading recent transactions:", err));
            }

            if (view === "profile") {
                fetch("/points/top?n=1")
                    .then(res => {
                        if (!res.ok) throw new Error("Network response was not ok");
                        return res.json();
                    })
                    .then(data => {
                        if (!data.length) return;
                        const { accumulatedPoints, rangeUser } = data[0];
                        const limits = { BRONZE: 500, SILVER: 1000, GOLD: 5000, PLATINUM: Number.MAX_SAFE_INTEGER };
                        const maxPts = limits[rangeUser] || 500;
                        const pct    = Math.min(100, Math.round(accumulatedPoints / maxPts * 100));

                        document.getElementById("profile-rank-badge").textContent =
                            rangeUser.charAt(0) + rangeUser.slice(1).toLowerCase();
                        const bar = document.getElementById("profile-rank-progress");
                        bar.style.width = pct + "%";
                        bar.setAttribute("aria-valuenow", pct);
                        document.getElementById("profile-rank-text").textContent =
                            `${accumulatedPoints} / ${maxPts} pts`;
                    })
                    .catch(err => console.error("Error loading profile points:", err));

                fetch("/users/getAccounts", { method: "POST" })
                    .then(res => res.ok ? res.json() : Promise.reject("Error fetching accounts"))
                    .then(accts => {
                        // sumamos todos los balances
                        const total = accts.reduce((sum, acct) => sum + parseFloat(acct.balance), 0);
                        document.getElementById("profile-balance").textContent = `$${total.toFixed(2)}`;
                    })
                    .catch(console.error);
            }

            if (view === "history") {
                // 1) Inyectamos la plantilla que incluye el balance
                content.innerHTML = `
                <h2 class="mb-4">Movements</h2>

                <!-- Balance Card -->
                <div class="card custom-card mb-4">
                  <h3>Current Balance</h3>
                  <p class="balance-amount">$0.00</p>
                </div>

                <!-- Full Movements Table -->
                <div class="card custom-card">
                  <h4 class="mb-3">All movements</h4>
                  <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover align-middle">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Type</th>
                          <th>Destiny</th>
                          <th>Amount</th>
                          <th>Description</th>
                          <th>Date</th>
                        </tr>
                      </thead>
                      <tbody id="all-movements"></tbody>
                    </table>
                  </div>
                </div>
              `;

                // 2) Cargar y mostrar el balance real
                fetch("/users/getAccounts", { method: "POST" })
                    .then(res => res.ok ? res.json() : Promise.reject("Error fetching accounts"))
                    .then(accts => {
                        const total = accts.reduce((sum, a) => sum + parseFloat(a.balance), 0);
                        document.querySelector(".balance-amount").textContent = `$${total.toFixed(2)}`;
                    })
                    .catch(err => console.error(err));

                fetch("/transaction/all")
                    .then(res => res.ok ? res.json() : Promise.reject("Error fetching transactions"))
                    .then(data => {
                        const tbody = document.getElementById("all-movements");
                        tbody.innerHTML = data.length
                            ? data.map(tx => {
                                // Traducir el tipo
                                const tipo = {
                                    DEPOSIT:    "Deposit",
                                    WITHDRAWAL: "Withdrawal",
                                    TRANSFER:   "Transfer",
                                    RECEIVED:   "Received"
                                }[tx.type] || tx.type;

                                let amountClass;
                                switch (tx.type) {
                                    case "DEPOSIT":    amountClass = "text-success"; break;
                                    case "WITHDRAWAL": amountClass = "text-danger";  break;
                                    case "TRANSFER":   amountClass = "text-warning"; break;
                                    case "RECEIVED":   amountClass = "text-info";    break;
                                    default:           amountClass = "";
                                }

                                let sign = "+";
                                if (tx.type === "WITHDRAWAL" || tx.type === "TRANSFER") {
                                    sign = "-";
                                } else if (tx.type === "RECEIVED" || tx.type === "DEPOSIT") {
                                    sign = "+";
                                }

                                const absAmt = Math.abs(tx.amount).toFixed(2);


                                return `
              <tr>
                <td>#${tx.id}</td>
                <td class="${amountClass}">${tipo}</td>
                <td>${tx.destination}</td>
                <td class="${amountClass}">
                  ${sign} $${absAmt}
                </td>
                <td>${tx.description || ""}</td>
                <td>${tx.date.split("T")[0]}</td>
              </tr>
            `;
                            }).join("")
                            : `<tr><td colspan="6" class="text-center">No movements yet.</td></tr>`;
                    })
                    .catch(err => console.error(err));
            }

            // En tu script, dentro de loadView():
            if (view === "wallets") {
                // 1) Renderizamos la plantilla HTML
                content.innerHTML = views.wallets;

                // 2) Cargar mis wallets y volcarlas en tabla y lista de conexiones
                Promise.all([
                    fetch("/wallets?userId=" + user.id).then(r => r.json()),     // para lista simple
                    fetch("/wallets?userId=" + user.id).then(r => r.json())      // lo mismo en tabla; podrías unificar
                ]).then(([list, list2]) => {
                    // 2a) Tabla de wallets con botón Manage
                    const tbody = document.getElementById("wallet-table-body");
                    tbody.innerHTML = list2.map(w => `
          <tr data-wallet-id="${w.id}" data-wallet-name="${w.name}" data-wallet-balance="${w.balance}">
            <td>${w.name}</td>
            <td>$${parseFloat(w.balance).toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-light manage-wallet-btn">Manage</button>
            </td>
          </tr>
        `).join("");

                    // 2b) Listado y selects para conexión
                    const ul = document.getElementById("wallet-list");
                    ul.innerHTML = list.map(w =>
                        `<li data-id="${w.id}" data-name="${w.name}" data-balance="${w.balance}"
           class="list-group-item bg-secondary text-white d-flex justify-content-between wallet-item">
         ${w.name} — $${parseFloat(w.balance).toFixed(2)}
       </li>`
                    ).join("");

                    const src = document.getElementById("source-wallet"),
                        tgt = document.getElementById("target-wallet");
                    [src, tgt].forEach((sel, i) => {
                        sel.innerHTML =
                            `<option value="">${i===0?"From":"To"}</option>` +
                            list.map(w => `<option value="${w.id}">${w.name}</option>`).join("");
                    });

                    // También rellenar selects de transferencia
                    const from = document.getElementById("wallet-from"),
                        to   = document.getElementById("wallet-to");
                    [from, to].forEach((sel, i) => {
                        if (sel) {
                            sel.innerHTML = `<option value="">${i===0 ? "From" : "To"}</option>` +
                                list.map(w => `<option value="${w.id}">${w.name}</option>`).join("");
                        }
                    });


                    // 3) Attach click en cada Manage
                    document.querySelectorAll(".manage-wallet-btn").forEach(btn => {
                        btn.addEventListener("click", e => {
                            const tr = e.currentTarget.closest("tr");
                            const id   = tr.dataset.walletId;
                            const name = tr.dataset.walletName;
                            const bal  = tr.dataset.walletBalance;

                            // Rellenar modal
                            document.getElementById("modal-wallet-name").textContent    = name;
                            document.getElementById("modal-wallet-balance").textContent = parseFloat(bal).toFixed(2);
                            document.getElementById("manage-amount").value = "";

                            // Guardar walletId en el form
                            const form = document.getElementById("wallet-manage-form");
                            form.dataset.walletId = id;

                            // Mostrar modal
                            new bootstrap.Modal(document.getElementById("wallet-modal")).show();
                        });
                    });
                }).catch(console.error);

                document.getElementById("wallet-transfer-form").addEventListener("submit", e => {
                    e.preventDefault();
                    const from = document.getElementById("wallet-from").value;
                    const to = document.getElementById("wallet-to").value;
                    const amount = document.getElementById("wallet-transfer-amount").value;

                    if (!from || !to || !amount || from === to) return alert("Check input values");

                    fetch(`/wallets/transfer?fromWalletId=${from}&toWalletId=${to}&amount=${amount}`, {
                        method: "POST"
                    }).then(r => {
                        if (!r.ok) return r.text().then(text => { throw new Error(text) });
                        return r.text();
                    }).then(msg => {
                        alert(msg);
                        loadView("wallets");
                    }).catch(err => alert(err.message));
                });

                // 4) Crear nueva wallet
                document.getElementById("wallet-create-form").addEventListener("submit", e => {
                    e.preventDefault();
                    const name = document.getElementById("wallet-name").value;
                    fetch("/wallets", {
                        method: "POST",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ userId: user.id, name })
                    }).then(() => loadView("wallets"));
                });

                // 5) Conectar wallets en grafo
                document.getElementById("wallet-connect-form").addEventListener("submit", e => {
                    e.preventDefault();
                    const source = +document.getElementById("source-wallet").value;
                    const target = +document.getElementById("target-wallet").value;
                    if (!source || !target) return;
                    fetch("/wallets/graph/connect", {
                        method: "POST",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ userId: user.id, sourceWalletId: source, targetWalletId: target })
                    }).then(() => loadView("wallets"));
                });

                // 6) Mostrar grafo
                fetch("/wallets/graph?userId=" + user.id)
                    .then(r => r.json())
                    .then(map => {
                        document.getElementById("wallet-graph").textContent =
                            JSON.stringify(map, null, 2);
                    });

                // 7) Deposit & Withdraw dentro del modal
                const form = document.getElementById("wallet-manage-form");
                const amtInput = document.getElementById("manage-amount");
                document.getElementById("btn-deposit").onclick = () => {
                    const walletId = form.dataset.walletId;
                    const amt = parseFloat(amtInput.value);
                    if (!amt || amt <= 0) return alert("Enter a valid amount");
                    fetch(`/wallets/${walletId}/deposit?amount=${amt}`, { method: "POST" })
                        .then(r => r.json())
                        .then(newBal => {
                            document.getElementById("modal-wallet-balance").textContent = parseFloat(newBal).toFixed(2);
                            refreshBalances();
                            loadView("wallets");
                            bootstrap.Modal.getInstance(document.getElementById("wallet-modal")).hide();
                        })
                        .catch(console.error);
                };
                document.getElementById("btn-withdraw").onclick = () => {
                    const walletId = form.dataset.walletId;
                    const amt = parseFloat(amtInput.value);
                    if (!amt || amt <= 0) return alert("Enter a valid amount");
                    fetch(`/wallets/${walletId}/withdraw?amount=${amt}`, { method: "POST" })
                        .then(r => {
                            if (!r.ok) throw new Error("Insufficient funds");
                            return r.json();
                        })
                        .then(newBal => {
                            document.getElementById("modal-wallet-balance").textContent = parseFloat(newBal).toFixed(2);
                            refreshBalances();
                            loadView("wallets");
                            bootstrap.Modal.getInstance(document.getElementById("wallet-modal")).hide();
                        })
                        .catch(err => alert(err.message));
                };

                // 8) Delete Wallet
                document.getElementById("wallet-delete-btn").onclick = e => {
                    const walletId = document.getElementById("wallet-manage-form").dataset.walletId;
                    fetch(`/wallets/${walletId}`, { method: "DELETE" })
                        .then(() => {
                            refreshBalances();
                            loadView("wallets");
                            bootstrap.Modal.getInstance(document.getElementById("wallet-modal")).hide();
                        });
                };
            }


            if (view === "bank_accounts" || view === "home") {
                fetch("/users/getAccounts", {
                    method: "POST"
                })
                    .then(r => r.json())
                    .then(data => {

                        const list = document.getElementById("bank-accounts-list");
                        list.innerHTML = data.length
                            ? data.map(account => `
                    <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Account #${account.id}</strong><br>
                            Number: ${account.accountNumber}
                        </div>
                        <span class="badge bg-primary rounded-pill">$${account.balance.toFixed(2)}</span>
                    </li>
                `).join("")
                            : `<li class="list-group-item bg-dark text-light text-center">No accounts yet.</li>`;
                    });

                const accountForm = document.getElementById('account-form');
                if (accountForm) {
                    accountForm.addEventListener('submit', function (e) {
                        e.preventDefault();

                        const form = e.target;
                        const formData = new FormData(form);

                        fetch('/Accounts/add', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error("Error al registrar");
                                }
                                return response.text();
                            })
                            .then(data => {
                                const successModalEl = document.getElementById("successModal");
                                if (successModalEl) {
                                    const successModal = bootstrap.Modal.getOrCreateInstance(successModalEl);
                                    successModal.show();
                                }
                                form.reset();
                            })
                            .catch(error => {
                                alert("There was an error adding the account.");
                                console.error("Error adding account:", error);
                            });
                    });
                }
            }

            if (view === "statistics") {
                // 1) Category transitions (barras)
                fetch("/stats/patterns/categories")
                    .then(r=>r.json())
                    .then(data=>{
                        const labels = data.map(d=>d.category);
                        const counts = data.map(d=>d.count);
                        const ctx = document.getElementById("categoryChart").getContext("2d");
                        new Chart(ctx, {
                            type: "bar",
                            data: { labels, datasets:[{ label:"Transitions", data:counts }] },
                            options: {
                                scales: { y:{ beginAtZero:true, ticks:{ color:"white" }}, x:{ ticks:{ color:"white" }} },
                                plugins: { legend:{ display:false } }
                            }
                        });
                    }).catch(console.error);

                // 2) Frequent Transfers (barras horizontales)
                fetch("/stats/clients/frequent")
                    .then(r=>r.json())
                    .then(data=>{
                        const labels = data.map(d=>d.label);
                        const counts = data.map(d=>d.count);
                        const ctx = document.getElementById("clientGraphChart").getContext("2d");
                        new Chart(ctx, {
                            type: "bar",
                            data: { labels, datasets:[{ label:"Transfers", data:counts }] },
                            options: {
                                indexAxis: 'y',
                                scales: { x:{ beginAtZero:true, ticks:{ color:"white" }}, y:{ ticks:{ color:"white" }} },
                                plugins: { legend:{ display:false } }
                            }
                        });
                    }).catch(console.error);

                // 3) Affinity groups (badges)
                fetch("/stats/clients/groups")
                    .then(r=>r.json())
                    .then(groups=>{
                        const container = document.getElementById("affinity-groups");
                        container.innerHTML = groups.length
                            ? groups.map((grp,i)=>`
            <div class="badge bg-secondary p-2">
              Group ${i+1}: ${grp.map(u=>u.label).join(", ")}
            </div>
          `).join("")
                            : `<p class="text-center text-muted">No affinity groups.</p>`;
                    }).catch(console.error);
            }


        }

        // Arranca en HOME
        loadView("home");

        // Nav lateral
        document.querySelectorAll(".nav-link[data-section]")
            .forEach(a => a.addEventListener("click", e => {
                e.preventDefault();
                loadView(a.dataset.section);
            }));
    });
</script>


<!-- Modal de confirmación de logout -->
<div class="modal fade" id="logout-modal" tabindex="-1" aria-labelledby="logout-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary shadow">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="logout-modal-label">Confirm Log Out</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to log out?</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-logout">Yes, log out</button>
            </div>
        </div>
    </div>
</div>

<!-- modal para la opción de envío -->
<div class="modal fade" id="send-money-modal" tabindex="-1" aria-labelledby="send-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #2b2f38; color: white; border-radius: 1rem; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #444;">
                <h5 class="modal-title" id="send-modal-label">Send to</h5>
                <button type="button" class="btn-close" style="filter: invert(1);" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="send-form" action="/transaction/send" method="POST">
                <div class="modal-body">
                    <p>Make sure you enter the data correctly</p>
                    <div id="form-error" class="text-danger mb-2" style="display: none;"></div>

                    <div class="mb-3">
                        <label for="inputDestinyAccount" class="form-label">Destiny Number Account</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" id="inputDestinyAccount" name="accountNumber" required>
                    </div>

                    <div class="mb-3">
                        <label for="selectPurse" class="form-label">Send from account</label>
                        <select id="selectPurse" name="accountOriginId" class="form-select bg-dark text-white border-secondary" required>
                            <option value="" disabled selected>Select an account</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="inputAmount" class="form-label">Amount</label>
                        <input type="number" step="1000" class="form-control bg-dark text-white border-secondary" id="inputAmount" name="amount" required>
                    </div>

                    <div class="mb-3">
                        <label for="inputDescription" class="form-label">Description</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="inputDescription" name="description">
                    </div>

                    <div class="mb-3">
                        <label for="selectCategory" class="form-label">Category</label>
                        <select id="selectCategory" name="category" class="form-select bg-dark text-white border-secondary">
                            <option value="" disabled selected>Select a category</option>
                        </select>
                    </div>

                    <input type="hidden" id="scheduledDatetime" name="scheduledDatetime">
                </div>

                <div class="modal-footer" style="border-top: 1px solid #444;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" onclick="clearSchedule()">Send</button>
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#schedule-modal">Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- modal para programar envío -->
<div class="modal fade" id="schedule-modal" tabindex="-1" aria-labelledby="schedule-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content" style="background-color: #2b2f38; color: white; border-radius: 1rem; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #444;">
                <h5 class="modal-title" id="schedule-modal-label">Schedule Transaction</h5>
                <button type="button" class="btn-close" style="filter: invert(1);" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label for="scheduledDate" class="form-label">Date</label>
                    <input type="date" class="form-control bg-dark text-white border-secondary" id="scheduledDate" name="scheduledDate">
                </div>
                <div class="mb-3">
                    <label for="scheduledTime" class="form-label">Time</label>
                    <input type="time" class="form-control bg-dark text-white border-secondary" id="scheduledTime" name="scheduledTime">
                </div>
            </div>

            <div class="modal-footer" style="border-top: 1px solid #444;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scheduleTransaction()">Save</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Gestión de Wallet -->
<div class="modal fade" id="wallet-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-0">
                <h5 class="modal-title">Manage Wallet</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Name:</strong> <span id="modal-wallet-name"></span></p>
                <p><strong>Balance:</strong> $<span id="modal-wallet-balance">0.00</span></p>
                <form id="wallet-manage-form">
                    <div class="mb-3">
                        <label for="manage-amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control bg-dark text-white" id="manage-amount" />
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-warning w-100" id="btn-withdraw">Withdraw</button>
                        <button type="button" class="btn btn-success w-100" id="btn-deposit">Deposit</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-danger w-100" id="wallet-delete-btn">Delete Wallet</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para la opcion de depositar -->
<div class="modal fade" id="deposit-modal" tabindex="-1" aria-labelledby="deposit-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="deposit-modal-label">Deposit Funds</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deposit-form" action="/transaction/deposit" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="selectPurse2" class="form-label">Select an account to deposit into</label>
                        <select id="selectPurse2" name="accountDestiny" class="form-select bg-dark text-white border-secondary" required>
                            <option value="" disabled selected>Select an account</option>
                        </select>
                    </div>
                    <p>Please enter your card information to proceed with the deposit.</p>
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">Card Number</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary"
                               id="cardNumber" placeholder="1234 5678 9012 3456"
                               maxlength="19" pattern="\d{4} \d{4} \d{4} \d{4}"
                               inputmode="numeric" name="accountOriginNumber">
                    </div>
                    <div class="mb-3">
                        <label for="cardName" class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="cardName" placeholder="John Doe">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date MM/YY</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary"
                                   id="expiryDate" placeholder="MM/YY" maxlength="5" pattern="\d{2}/\d{2}"
                                   inputmode="numeric">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="password" class="form-control bg-dark text-white border-secondary"
                                   id="cvv" placeholder="123" maxlength="4" pattern="\d{3,4}"
                                   inputmode="numeric">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="depositAmount" class="form-label">Amount</label>
                        <input type="number" step="1000" class="form-control bg-dark text-white border-secondary" id="depositAmount" name="depositAmount" placeholder="10000">
                    </div>
                </div>

                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Deposit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="content">
    <div id="main-content" class="container mt-4">
        <h1 class="mb-4">Balance Dashboard</h1>

        <!-- Balance Card -->
        <div class="card custom-card mb-4">
            <h3>Current Balance</h3>
            <p class="balance-amount">$0.00</p>
            <span class="badge bg-success">+0 pts</span>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center flex-wrap gap-3 mt-4">
                <button type="button" class="btn btn-primary px-4" id="send-link"><i class="bi bi-send-fill me-2"></i>Send</button>
                <button type="button" class="btn btn-success px-4" id="deposit-link"><i class="bi bi-wallet2 me-2"></i>Deposit</button>
                <button type="button" class="btn btn-info px-4" id="btn-bank-accounts"><i class="bi bi-credit-card-2-front-fill me-2"></i>Bank Accounts</button>
            </div>
        </div>

        <!-- Transactions History -->
        <div class="card custom-card">
            <h3 class="mb-3">Movements</h3>
            <!-- Aquí meteremos las 3 más recientes -->
            <div id="recent-transactions"></div>
            <a href="#" id="see-history" class="btn btn-link text-white mt-3 p-0">See all movements</a>
        </div>

    </div>
</div>
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-success text-white">
            <div class="modal-header">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                successful process!
            </div>
        </div>
    </div>
</div>


<script>
    // Bar Chart
    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Active Users',
                data: [120, 150, 180, 90, 200, 170],
                backgroundColor: '#ff9800', // naranja
                borderColor: '#ffa726',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: 'white' } }
            },
            scales: {
                x: { ticks: { color: 'white' } },
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' }
                }
            }
        }
    });

    // Line Chart
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Revenue',
                data: [3000, 4000, 3200, 5000, 6000, 5500],
                fill: false,
                borderColor: '#ba68c8', // púrpura claro
                backgroundColor: '#ba68c8',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: 'white' } }
            },
            scales: {
                x: { ticks: { color: 'white' } },
                y: { ticks: { color: 'white' } }
            }
        }
    });
</script>
<script>
    fetch('/transaction/patterns/categories')
        .then(res => res.json())
        .then(data => {
            // data = [{ category: 'FOOD', count: 10 }, … ]
            const labels = data.map(d => d.category);
            const counts = data.map(d => d.count);

            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white' }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        })
        .catch(err => console.error('Error loading category stats:', err));
</script>

<script>
    document.getElementById('send-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const errorDiv = document.getElementById('form-error');
        const selectPurse = document.getElementById('selectPurse');
        const selectCategory = document.getElementById('selectCategory');

        let errorMessages = [];

        if (!selectPurse.value) {
            errorMessages.push('Please select an account to send from.');
        }
        if (!selectCategory.value) {
            errorMessages.push('Please select a category.');
        }

        if (errorMessages.length > 0) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = errorMessages.join('<br>');
            return;
        } else {
            errorDiv.style.display = 'none';
        }


        fetch('/transaction/send', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server error');
                }
                return response.json();
            })
            .then(data => {
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
            })
            .catch(error => {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = 'Error: ' + error.message;
            });
    });

    document.getElementById('deposit-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const selectPurse = document.getElementById('selectPurse2');
        const errorDiv = document.getElementById('form-error');

        let errorMessages = [];

        if (!selectPurse.value) {
            errorMessages.push('Please select an account to send from.');
        }

        if (errorMessages.length > 0) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = errorMessages.join('<br>');
            return;
        } else {
            errorDiv.style.display = 'none';
        }

        const formData = new FormData(event.target);


        fetch('/transaction/deposit', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                    event.target.reset();
                } else {
                    return response.text().then(text => { throw new Error(text); });
                }
            })
            .catch(error => {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = 'There was an error processing the request.';
                console.error('Error:', error);
            });
    });

</script>

<script>
    document.getElementById('cardNumber').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.substring(0, 16);
        value = value.replace(/(.{4})/g, '$1 ').trim();
        e.target.value = value;
    });
</script>

<script>
    document.getElementById('expiryDate').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 3) {
            value = value.substring(0, 4);
            value = value.replace(/(\d{2})(\d{1,2})/, '$1/$2');
        }
        e.target.value = value;
    });
</script>

<script>
    function clearSchedule() {
        document.getElementById("scheduledDatetime").value = "";
    }
</script>

<script>
    function scheduleTransaction() {
        const date = document.getElementById("scheduledDate").value;
        const time = document.getElementById("scheduledTime").value;
        const errorDiv = document.getElementById('form-error');

        if (!date || !time) {
            alert("Please select both date and time.");
            return;
        }
        const scheduledDatetime = `${date}T${time}`;
        document.getElementById("scheduledDatetime").value = scheduledDatetime;

        const form = document.getElementById("send-form");
        form.action = "/transaction/schedule";

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {

                    const modal = new bootstrap.Modal(document.getElementById('successModal'));
                    modal.show();
                    form.reset();
                } else {
                    return response.text().then(text => { throw new Error(text); });
                }
            })
            .catch(error => {
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = 'There was an error scheduling the transaction.';
                } else {
                    alert('There was an error scheduling the transaction.');
                }
                console.error('Schedule Error:', error);
            });
    }
</script>

<!-- Chart.js CDN  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>
</html>
